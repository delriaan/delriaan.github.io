//`json_queue`: An array of JSON file paths, each containing HTML markup.
let json_queue = fetch("json/articles.json");

// `articles`: JSON-parsed content.
let articles = json_queue.then((x) => x.json()).then((y) => y);

// `dom_ids`: A list of tag identifiers corresponding to dynamic HTML targets:
const dom_ids = ['headline', 'predictions', 'article'];

// `get_random_index()`: A randomizer function
let get_random_index = (l) => Math.floor(Math.random() * l + 1) - 1;

// `setArticle()`: A function to update the DOM with the article content
let setArticle = function(article){
  for (let i = 0; i < dom_ids.length; i++) {
    const dom_id = dom_ids[i];
    
    const text = article[0][dom_id];
    
    // Find the target DOM object and update the HTML markup:
    $("#" + dom_id).html(text);
    
    if (dom_id == "headline"){
      const anchor_string = `<a href="${article[0].url}" title="${article[0].title}">${$("#" + dom_id + " h4").text()}</a>`;
      $("#" + dom_id + " h4").html(anchor_string);
    }
  }
};

$(document).ready(function(){
  // Other Javascript/JQuery to include (optional):
  // Add a button object:
  let article_button = '<button id="randomize" class="get-new-result" style="font-weight:bold; padding:5px; " title="Click to randomly select a new result.">Get New Result</button> | ';
   
  // Add attributes to toggalable DOM elements generated by Rmarkdown:
  $("span[context='note']").parent().next().attr({"context" : "note", "toggleGroup" : "0"});

  // Initially, hide all toggle DOM elements:
  $("ul[context='note']").hide();

  // Toggle Event Callbacks
  $("[role='toggle']").click(
    function(){
      lgrp = $(this).attr("toggleGroup");
      hint = $(this).find("hint").first();
      
      if (hint.text() == "[show]"){ hint.text("<hide>"); }
      else { hint.text("[show]"); }
 
      // Attach an event to each of the target DOM elements (created when R function 'hint_js()' was invoked):
      $("ul[toggleGroup='" + lgrp + "']").fadeToggle(10);
    }); 
  
  $("span[context='note']").click(); 
  $("#predictions").before(article_button); 
  
  // $("#randomize") is the button object:
  $("#randomize").click(function(){ 
    res = articles
      // Retrieve a random article file reference:
      .then((x) => x[get_random_index(x.length)])
      // Retrieve the JSON, parse, and extract the HTML content:
      .then(fetch)
      .then((x) => x.json())
      // Update the DOM:
      .then(setArticle);
  });
  
  // Initialize the HTML DOM elements:
  $("#randomize").click();
});

