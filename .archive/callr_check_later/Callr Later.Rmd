---
title: "CallR ... Check Later"
author: "`r sprintf('Chionesu George <sup>%s</sup>', Sys.Date())`"
output:
  html_document:
    df_print: paged
---
# {.tabset .tabset-fade .tabset-pills} 

The following is an toy example for starting a `callr` background process and `later` periodically checking its status in a ***non-blocking*** manner.
The code is set up to make it easy to populate variables and build calls.

## `later::later()` Objects &#9655;

```{r}
ASSIGN_ENV <- .GlobalEnv;
LATER_OBJ_NAME <- "check_this"
LATER_FUNC <- function(){
  # This is a recursive call using an active binding
  ASSIGN_ENV[[LATER_OBJ_NAME]]
}
LATER_DELAY <- 5
BINDING_FUNC <- function(){
  if (!globalenv()[[BG_OBJ_NAME]]$is_alive()){
    cat(sprintf("[%s] Completed!", Sys.time()), sep = "\n")
    OUTPUT <<- globalenv()[[BG_OBJ_NAME]]$get_result();
  } else {
    cat(sprintf("[%s] Still alive ...", Sys.time()), sep = "\n");
    later::later(LATER_FUNC, delay = LATER_DELAY)
  }
}
rlang::inject(makeActiveBinding(LATER_OBJ_NAME, BINDING_FUNC, env = ASSIGN_ENV));
```
## `callr::callr()` Objects &#9655;
```{r}
CALLR_FUNC <- function(start_time, timeout){
  force(start_time);
  force(timeout);

  k <- start_time;
  while(as.numeric(k - (start_time + timeout)) < 0){
    Sys.sleep(5)
    k <- Sys.time()
  }
  k
}
CALLR_ARGS <- list(start = Sys.time(), timeout = 60);
BG_OBJ_NAME <- "this_action"
``` 
## CallR ... Check Later &#9655;
* If **`r BG_OBJ_NAME`** has completed, return the result and possibly to other things
* If **`r BG_OBJ_NAME`** is still active, check **`r BG_OBJ_NAME`** in **`r LATER_DELAY`** seconds


### Start the background process 
```{r}
assign(BG_OBJ_NAME, callr::r_bg(func = CALLR_FUNC, args = CALLR_ARGS));
```

### Initiate iterative process status checks 
`r htmltools::tags$code(LATER_OBJ_NAME)`:
```{r echo=FALSE}
eval(as.symbol(LATER_OBJ_NAME));
```

**`r LATER_OBJ_NAME`** should indicate completion in **`r CALLR_ARGS$timeout`** seconds

## Full Source Code 
```{r echo=FALSE}
suppressWarnings(readLines("C:/Users/Chionesu/OneDrive/Projekz/Templates & Snippets/CallR Later.R")) |> 
  purrr::discard(~grepl("^rm", .x)) |>
  paste(collapse = "<br>") |> 
  htmltools::HTML() |>
  htmltools::tags$code(style = "color:dark-blue;") |>
  htmltools::tags$p(style = "background-color:#EFEFEF; border:solid 1px #AAAAAA; width:960px; height:auto;")
```
